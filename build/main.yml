trigger:
  branches:
   include:
   - main
  tags:
    include:
    - v*

resources:
  repositories:
    - repository: 1esPipelines
      type: git
      name: 1ESPipelineTemplates/1ESPipelineTemplates
      ref: refs/tags/release

extends:
  template: v1/1ES.Official.PipelineTemplate.yml@1esPipelines
  parameters:
    pool:
      name: 1es-windows-2019-x64
      os: windows

  stages:
    - stage: Build
      jobs:
      - job: linux_64
        pool:
          vmImage: 'ubuntu-latest'
        templateContext:
          outputs:
            - output: pipelineArtifact
              targetPath: '$(Build.ArtifactStagingDirectory)/drop.zip'
              artifactName: drop
        steps:
          - template: linux.yml@self
            parameters:
              target: x86_64-unknown-linux-musl
      - job: linux_32
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - template: linux.yml@self
            parameters:
              target: i686-unknown-linux-musl
      - job: linux_arm
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - template: linux.yml@self
            parameters:
              target: arm-unknown-linux-gnueabihf
      - job: linux_aarch64
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - template: linux.yml@self
            parameters:
              target: aarch64-unknown-linux-gnu
      - job: linux_aarch64_musl
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - template: linux.yml@self
            parameters:
              target: aarch64-unknown-linux-musl
      - job: macOS
        pool:
          vmImage: macOS-latest
        steps:
          - template: linux.yml@self
            parameters:
              target: x86_64-apple-darwin
      - job: macOS_arm64
        pool:
          vmImage: macOS-latest
        steps:
          - template: linux.yml@self
            parameters:
              target: aarch64-apple-darwin
      - job: win_64
        pool:
          vmImage: windows-2022
        steps:
          - template: windows.yml@self
            parameters:
              target: x86_64-pc-windows-msvc
      - job: win_64_apiscan
        pool:
          vmImage: windows-2022
        steps:
          - template: windows-apiscan.yml@self
            parameters:
              target: x86_64-pc-windows-msvc
      - job: win_32
        pool:
          vmImage: windows-2022
        steps:
          - template: windows.yml@self
            parameters:
              target: i686-pc-windows-msvc
      - job: win_arm64
        pool:
          vmImage: windows-2022
        steps:
          - template: windows.yml@self
            parameters:
              target: aarch64-pc-windows-msvc
      - job: ppc64le
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - template: linux.yml@self
            parameters:
              target: powerpc64le-unknown-linux-gnu
      - job: s390x
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - template: linux.yml@self
            parameters:
              target: s390x-unknown-linux-gnu
      - job: publish
        pool:
          vmImage: 'ubuntu-latest'
        condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/v'))
        dependsOn:
        - linux_64
        - linux_32
        - linux_arm
        - linux_aarch64
        - linux_aarch64_musl
        - macOS
        - macOS_arm64
        - win_64
        - win_32
        - win_arm64
        - ppc64le
        - s390x
        steps:
          - template: publish.yml
